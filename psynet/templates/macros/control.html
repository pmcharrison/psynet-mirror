{% macro null(config) %}
    <script>
        on_next_button = function() {
            $(this).prop('disabled', true);
            if (typeof retrieve_response == "undefined") {
                psynet.next_page();
            } else {
                response = retrieve_response();
                psynet.next_page(
                    response.raw_answer,
                    response.metadata,
                    response.blobs
                );
            }
        }
    </script>

    <button type="button" id="next_button" class="btn btn-primary btn-lg submit" onclick="on_next_button();">
        Next
    </button>
{% endmacro %}

{% macro push_button(config) %}
    <button
        type="button"
        class="btn push_button btn-primary response {% if config.timed == true %} timed {% else %} submit {% endif %}"
        id="{{ config.id }}"
        onclick="clicked_button(this, '{{ config.id }}');"
        style="{{ config.style }}"
    >
        {{ config.label }}
    </button>
{% endmacro %}

{% macro push_buttons(config) %}
    <style>
        .push-button-container {
            display: {% if config.arrange_vertically %}grid{% else %}flex{% endif %};
            flex-wrap: wrap;
            justify-content: center;
            max-height: 420px;
            overflow-y: auto;
        }
    </style>

    <div class="push-button-container">
        {% for button in config.push_buttons %}
            {{ push_button(button) }}
        {% endfor %}
    </div>

    {% if config.timed == true %}
        <p class="vspace"></p>
        {{ null(config) }}
    {% endif %}

    <script>
        let button_timers = {};

        clicked_button = function(button, id) {
            let info = {button_id: id};
            psynet.register_event("push_button_clicked", info);

            {% if config.timed == true %}
                let button_highlight_duration = {{ config.button_highlight_duration }};
                if (button_timers[id] !== undefined) {
                    clearTimeout(button_timers[id]);
                }
                highlight_button(button);
                button_timers[id] = setTimeout(unhighlight_button, button_highlight_duration * 1000, button);
            {% else %}
                psynet.response.disable();
                psynet.submit.disable();
                psynet.next_page(id);
            {% endif %}
        }

        highlight_button = function(button) {
            button.classList.remove("btn-primary");
            button.classList.add("btn-success");
        }

        unhighlight_button = function(button) {
            button.classList.add("btn-primary");
            button.classList.remove("btn-success");
        }
    </script>
{% endmacro %}

{% macro checkbox(config) %}
    <label style="margin-left: 15px;">
        <input
            type="checkbox"
            id="{{ config.id }}"
            name="{{ config.name }}"
            class="response"
        />
        <span>{{ config.label }}</span>
    </label>
{% endmacro %}

{% macro checkboxes(config) %}
    <style>
        .control-container {
            display: {% if config.arrange_vertically %}grid{% else %}flex{% endif %};
            flex-wrap: wrap;
            justify-content: center;
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
    <div class="control-container">
        {% for _checkbox in config.checkboxes %}
            {{ checkbox(_checkbox) }}
        {% endfor %}
    </div>
    <p class="vspace"></p>
    <div style="justify-content: center; display: flex; margin-top">
        {{ null(config) }}
    </div>
    <script>
        clicked_button = function(id) {
            psynet.response.disable();
            psynet.submit.disable();
            psynet.next_page(id);
        }

        retrieve_response = function() {
            let elements = document.getElementsByName('{{ config.name }}')
            checked_values = Array.from(elements).map(function(element, i) {
                if (element.checked) {return element.id}
            }).filter(function (element) {
              return element != null;
            });
            return {
                raw_answer: checked_values
            }
        }
    </script>
{% endmacro %}

{% macro radiobutton(config) %}
    <label style="margin-left: 15px;">
        <input
            type="radio"
            id="{{ config.id }}"
            name="{{ config.name }}"
            class="response"
            style="{{ config.style }}"
        />
        <span style="{{ config.style }}">{{ config.label }}</span>
    </label>
{% endmacro %}

{% macro radiobuttons(config) %}
    <style>
        .control-container {
            display: {% if config.arrange_vertically %}grid{% else %}flex{% endif %};
            flex-wrap: wrap;
            justify-content: center;
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
    <div class="control-container">
        {% for button in config.radiobuttons %}
            {{ radiobutton(button) }}
        {% endfor %}
    </div>
    <p class="vspace"></p>
    <div style="justify-content: center; display: flex; margin-top">
        {{ null(config) }}
    </div>
    <script>
        clicked_button = function(id) {
            psynet.response.disable();
            psynet.submit.disable();
            psynet.next_page(id);
        }

        retrieve_response = function() {
            let element = document.querySelector('input[name="{{ config.name }}"]:checked')

            return {
                raw_answer: (element != null) ? element.id : null
            }
        }
    </script>
{% endmacro %}

{% macro dropdown_option(config) %}
    <option value="{{ config.value }}">{{ config.text }}</option>
{% endmacro %}

{% macro dropdown(config) %}
    <style>
        .dropdown-container {
            margin: 0 auto;
            width: fit-content;
        }
    </style>
    <div class="dropdown-container">
        <select id="{{ config.name }}" class="form-control response" style="cursor: pointer;" name="{{ config.name }}">
            <option disabled selected value>{{ config.default_text }}</option>
            {% for option in config.dropdown %}
                {{ dropdown_option(option) }}
            {% endfor %}
        </select>
    </div>
    <p class="vspace"></p>
    <div style="justify-content: center; display: flex; margin-top">
        {{ null(config) }}
    </div>
    <script>
        clicked_button = function(id) {
            psynet.response.disable();
            psynet.submit.disable();
            psynet.next_page(id);
        }

        retrieve_response = function() {
            let element = document.getElementById("{{ config.name }}");
            return {
                raw_answer: (element != null) ? element.value : null
            }
        }
    </script>
{% endmacro %}

{% macro slider(config) %}
    <style type="text/css">
        .slider-collection {
            margin: 30px;
        }

        .slider {
            margin: 20px;
        }

        input[type=range] {
            width: 50%;
            display: inline-block;
        }

        .slider-label {
            font-weight: bold;
            display: inline-block;
            min-width: 200px;
            text-align: right;
            margin-right: 20px;
        }

        .slider-value {
            width: 60px;
            display: inline-block;
            margin-left: 20px;
        }
    </style>

    <script>
        var init_sliders = function(){
            var slider = $('.slider'),
                range = $('.slider-range'),
                value = $('.slider-value');

            slider.each(function(){
                value.each(function(){
                    var value = $(this).prev().attr('value');
                    $(this).html(value);
                });

                range.on('input', function(){
                    $(this).next(value).html(this.value);
                });
            });
        };
        window.addEventListener("load", init_sliders);
    </script>

    <div class="slider-collection">
        {% for s in config.sliders %}
            <div class="slider">
                <span class="slider-label" style=>
                    {{ s.label }}
                </span>
                <input id="{{ s.slider_id }}" class="form-control-range response slider-range{% if not s.directional %} slider-non-directional{% endif %}"
                    type="range" style="display: inline-block;" min="{{ s.min_value }}"
                    max="{{ s.max_value + 0.0001 * s.step_size }}" step="{{ s.step_size }}"
                    value="{{ s.start_value }}">
                <span class="slider-value">NA</span>
            </div>
        {% endfor %}
    </div>
{% endmacro %}

{% macro audio_meter(config) %}
    <div class="audio_meter_block">
        <table style="width: 500px; padding: 10px">
            <tbody>
                <tr align="left" valign="middle">
                    <td width="300px">
                        <div style="background-color: black; width: 300px; height: 50px">
                            <canvas id="audio_meter" width="300" height="50"></canvas>
                        </div>
                    </td>
                    <td width="20px"></td>
                    <td align="left">
                        <p id="audio_meter_text" style="font-weight: bold; margin: 0px; display: none;"></p>
                    </td>
                </tr>
            </tbody>
        </table>

        {% if config.calibrate %}
            {{ audio_meter_calibrate(config) }}
        {% endif %}
    </div>

    {% if config.submit_button %}
        {{ null(config) }}
    {% endif %}

    <script>
        psynet.submit.wait_for("audio_meter");
        setTimeout(
            ()=> psynet.submit.ready("audio_meter"),
            1000 * {{ config.min_time }}
        );
    </script>

    <script>
        {% include "macros/control/audio_meter.js" %}

        audio_meter_control.init('{{ config.to_json() }}');
    </script>
{% endmacro %}

{% macro audio_meter_calibrate(config) %}
    <style type="text/css">
        #audio-meter-documentation {
            padding-top: 20px;
        }
    </style>

    <ul class="nav nav-tabs">
        <li><a href="#audio-meter-sliders" data-toggle="tab">Sliders</a></li>
        <li><a href="#audio-meter-documentation" data-toggle="tab">Documentation</a></li>
    </ul>

    <div class="tab-content">
        <div id="audio-meter-sliders" class="tab-pane active">
            {{ slider(config.sliders) }}
        </div>

        <div id="audio-meter-documentation" class="tab-pane">
            <p>
                The <strong>decay</strong> parameters determine the amount of smoothing
                that happens to the signal, and have units of seconds. A high decay parameter
                means that the signal takes a long time to decay (i.e. high smoothing).
                There are three decay parameters: one for the displayed audio meter,
                one for the 'too-high' detector, and one for the 'too-low' detector.
            </p>
            <p>
                The <strong>threshold</strong> parameters determine the point at which
                the volume is determined to be 'too high' or 'too low'.
            </p>
            <p>
                The <strong>grace</strong> parameters determine how long the volume must be
                outside the respective threshold for a warning message to be triggered.
            </p>
            <p>
                The <strong>message duration</strong> parameters determine how long
                warning messages are displayed for.
            </p>
        </div>
    </div>

    <script>
        setInterval(() => audio_meter_control.update_from_sliders(), 50);
    </script>
{% endmacro %}

{% macro audio_record(config) %}

    {% if config.show_meter %}
        {{ audio_meter(config.meter) }}
    {% endif %}

    <style>
        #record-status {
            margin-top: 20px;
            margin-bottom: 20px;
        }
    </style>

    <div id="record-status">
        <div id="record-wait" class="alert record-alert alert-warning" role="alert" style="display: block;">
            Waiting to record...
        </div>

        <div id="record-active" class="alert record-alert alert-danger" role="alert" style="display: none;">
            Recording...
        </div>

        <div id="record-finish" class="alert record-alert alert-success" role="alert" style="display: none;">
            Uploading finished.
        </div>

        <div id="record-upload" class="alert record-alert alert-warning" role="alert" style="display: none;">
            Uploading response...
        </div>
    </div>

    {{ null(config) }}

    <script>
        {% include "macros/control/recorder.js" %}

        {% autoescape off %}
        var presignedUrl = "{{ config.presigned_url }}";
        {% endautoescape %}
        var recorder;

        psynet.media.register_on_loaded_routine(function() {
            navigator.mediaDevices.getUserMedia({
                audio: {
                    autoGainControl: false,
                    echoCancellation: false,
                    noiseSuppression: false
                },
                video: false
            }).then(function(stream) {
                psynet.log.debug("Initialising recorder.");
                let input = psynet.media.audio_context.createMediaStreamSource(stream);
                recorder = new Recorder(input);
                psynet.response.ready("recorder_ready")
            })
        });

        psynet.response.wait_for("page_load_buffer");
        psynet.response.wait_for("recorder_ready");
        psynet.submit.wait_for("finished-recording");

        setTimeout(function() {
            psynet.response.ready("page_load_buffer");
        }, 1000)

        startRecording = function() {
            psynet.log.debug("Starting recording.");
            psynet.register_event("audio_record_start");
            $(".record-alert").hide();
            $("#record-active").show();
            recorder.clear();
            recorder.record();
        }

        endRecording = function() {
            psynet.log.debug("Ending recording.")
            psynet.register_event("audio_record_end");
            recorder.exportWAV(function (blob) {
                $(".record-alert").hide();
                $("#record-upload").show();
                startPresignedUrlUpload(blob);
            })
        }

        startPresignedUrlUpload = function(wavAudioBlob) {
            // TODO upload if LOCAL_S3
            let xhr = new XMLHttpRequest();
            xhr.open('PUT', presignedUrl, true);
            psynet.log.debug("Presigned URL for upload to S3: " + presignedUrl);

            psynet.register_event("presigned_url_start_upload", {url: presignedUrl});

            xhr.onload = function(e) {
                psynet.log.debug("File uploaded successfully to presigned url.");
                psynet.register_event("presigned_url_end_upload", {url: presignedUrl});
                psynet.submit.ready("finished-recording");
                $(".record-alert").hide();
                $("#record-finish").show();
            };

            let wavFile = new File([wavAudioBlob], "s3_upload.wav")
            xhr.send(wavFile);
        }

        retrieve_response = function() {
            return {
                raw_answer: presignedUrl
            }
        }

        psynet.response.register_on_ready_routine(function() {
            startRecording();
            setTimeout(endRecording, 1000 * {{ config.duration }});
        });
    </script>
{% endmacro %}

{% macro text(config) %}
    <style>
        #text_input_container {
            margin: 15px;
            display: flex;
            justify-content: center;
        }
        #text_input {
            {% if config.width is not none %} width: {{ config.width }}; {% endif %}
            {% if config.height is not none %} height: {{ config.height }}; {% endif %}
        }
    </style>

    <div id="text_input_container">
        {% if config.one_line %}
            <input id="text_input" class="form-control response" type="text" value=""/>
        {% else %}
            <textarea id="text_input" class="form-control response" type="text"></textarea>
        {% endif %}
    </div>

    <script>
        retrieve_response = function() {
            return {
                raw_answer: $("#text_input").get(0).value
            }
        }
    </script>

    {{ null(config) }}
{% endmacro %}

{% macro video_slider(config) %}
    <style>
        #slider_video_container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 25px;
            min-height: {{ config.height }};
            min-width: {{ config.width }};
        }
        #slider_container {
            margin: 25px;
            {% if config.hide_slider == true %} display: none; {% endif %}
        }
        #slider {
            {%if config.reverse_scale %} direction: rtl {% endif %}
        }
    </style>

    <div id="slider_video_container">
        <video id="slider_video" class="loader" width="{{ config.width }}" height="{{ config.height }}">
            <source src="" type="video/{{ config.file_type }}"
        </video>
    </div>


    <div id="slider_container">
        <input id="slider" class="form-control-range response slider-range{% if not directional %} slider-non-directional{% endif %}"
        type="range" style="display: inline-block;" min="0" max="1" step="0.001"
        value="{{ config.starting_value }}">
    </div>

    {{ null(config) }}

    <script>
        update_video_from_slider = function() {
            var slider_value = document.getElementById("slider").value;
            var video = document.getElementById("slider_video");
            if (psynet.response.ready_done && !isNaN(video.duration)) {
                video.currentTime = slider_value * video.duration;
            };
            window.requestAnimationFrame(update_video_from_slider);
        }
        update_video_from_slider();

        var minimal_time = parseFloat("{{ config.minimal_time }}");
        psynet.submit.wait_for("slider_minimal_time");
        psynet.response.register_on_ready_routine(function() {
            setTimeout(function() {
                psynet.submit.ready("slider_minimal_time");
            }, minimal_time * 1000);
        });

        retrieve_response = function() {
            return {
                raw_answer: parseFloat($("#slider").get(0).value)
            }
        }
    </script>
{% endmacro %}

{% from "macros/graphics.html" import graphic_%}
{% macro graphic(config) %}
    {{ graphic_(config) }}
{% endmacro %}
