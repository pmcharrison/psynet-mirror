<!doctype html>
<html>
<head>
    <title>Network | Monitor </title>

    <style type="text/css">
        body {
            font: 10pt sans;
        }

        #mynetwork {
            width: 1200px;
            height: 600px;
            border: 1px solid lightgray;
        }
    </style>
    <!-- <link   rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"> -->
    <link   rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link   rel="stylesheet" href="/static/css/vis-network.min.css">
    <!-- <script src="/static/scripts/reqwest.min.js" type="text/javascript"> </script> -->
    <!-- <script src="/static/scripts/vis/vis.js" type="text/javascript"> </script> -->
    <!-- <link   href="/static/scripts/vis/vis-network.min.css" rel="stylesheet" type="text/css"/> -->
    <script src="/static/scripts/vis.min.js" type="text/javascript"></script>
    <!-- NORI: I CHANGED THIS TO STATIC REFERENCE FOR PERFORMANCE -->
    <!-- <link   href="https://unpkg.com/vis@4.17.0/dist/vis-network.min.css" rel="stylesheet" type="text/css"/> -->


    <script type="text/javascript">
        var nodes = null;
        var edges = null;
        var network = null;
        var ndata = {{ my_data |safe }};


        /// set display options and groups.
        function getOptions() {
          var options = {
            layout: {
                improvedLayout: false,
                 hierarchical: {
                     direction: 'UD',
                     sortMethod: 'directed',
                     edgeMinimization: false,
                     nodeSpacing: 80,
                     treeSpacing: 200
                 }
             },
             interaction: {dragNodes :false},
             physics: {
                enabled: false,
                stabilization:  false
             },

                        edges: {
                                width: 2
                        },

                        groups: {
                                failed_nodes: {
                                    color: 'red'
                                },
                                good_nodes: {
                                   // color: 'blue',
                                    font: {
                                          color: '#ffffff'
                                        }
                                },
                                failed_sources: {
                                    color: 'red',
                                    // shapeProperties:{borderDashes:[1,2]},
                                    color: {background:'red', border:'black'},
                                    border: 5,
                                    size: 30
                                },
                                good_sources: {
                                    color: {background:'blue', border:'black'},
                                    border: 5,
                                   // shapeProperties:{borderDashes:[1,2]},
                                    size: 30,
                                    font: {
                                          color: '#ffffff'
                                    }
                                },
                                group_networks_open: {
                                    shape: 'icon',
                                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0c2',
                                        size: 80,
                                        color: 'green'
                                    },
                                     font: {
                                          size: 14,
                                          color: 'green'
                                        }
                                },
                               

                                 group_networks_close: {
                                    shape: 'icon',
                                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0c2',
                                        size: 80,
                                        color: 'rgb(0,0,100)'
                                    },
                                     font: {
                                          size: 14,
                                          color: 'blue'
                                        }
                                },
                              
                                group_father: {
                                    shape: 'icon',
                                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0c2',
                                        size: 120,
                                        color: 'green'
                                    },
                                    font: {
                                          size: 25,
                                          color: '#000000'
                                        }
                                },

                                good_infos: {
                                    shape: 'icon',
                                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0e5',
                                        size: 30,
                                        color:'blue'
                                    }
                                },
                                failed_infos: {
                                    shape: 'icon',
                                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0e5',
                                        size: 30,
                                        color: 'red'
                                    }
                                },

                            }

                    }
                    return options
        }


        /// Draw the network...
        function getnNetwork() {
          var nodes = [];
          var edges = [];
          var list_of_nodes=[]; // list of objects with nodes
          var list_of_participants=[]; // list of objects with participants
          var list_of_node_indx=[]; // list of objects with nodes
          
          /// These lines finds all the roles that involved  in this networks
          roles=[]; // list of unique roles
          networks_roles=[]; // the role of each network
          for (var i = 0; i< ndata.net_structure.networks.length; i++) {
                          net=ndata.net_structure.networks[i];
                          my_role=net.role

                          is_found = false;
                          for (var j=0;j<roles.length;j++) {
                            if (my_role.localeCompare(roles[j])==0) {
                              is_found=true;
                              break;
                            }

                          }
                        if (!is_found) {
                              
                              networks_roles[net.id]=roles.length;
                              roles[roles.length]=my_role;

                        } else{
                          networks_roles[net.id]=j;
                        }
          }

          roles_colors=[]; ///  assign pseudorandom colors for each role
          for (var j=0;j<roles.length;j++) {
            rr= 50 + (((j+3)*11557)  % 200); // pseudorandom colors
            gg= 50 + (((j+3171)*31511) % 200);
            bb= 50 +  (((j+371)*11517) % 200);
            clr='rgb('+String(rr)+','+ String(gg)+',' + String (bb)+')';
            roles_colors[j]=clr;
          }

          // find all participants and make list, also asigned unique colors to partiicipants
          for (var i = 0; i< ndata.net_structure.participants.length; i++) {
            participant=ndata.net_structure.participants[i];
            participant_id=participant.id;
            if (participant_id==null) {
              participant_id=0;
              participant='<empty>';
            }
            rr= 10 +  (((i+357)*2551)  % 150); // pseudorandom colors
            gg= 30 +  (((i+3571)*2511) % 200);
            bb= 100 + (((i+3571)*2511) % 150);
            participant.clr='rgb('+String(rr)+','+ String(gg)+',' + String (bb)+')'
            list_of_participants[participant_id]=participant;
          }

          // pushing to the graph all nodes
          count_nodes=0;
          for (var i = 0; i< ndata.net_structure.nodes.length; i++) {
              node=ndata.net_structure.nodes[i];
              count_nodes++; // count the nodes
              list_of_nodes[node.id]=node;
              list_of_node_indx[node.id]=count_nodes;

              /// find if the node is a source:
              if (node.type.toLowerCase().search('source')>0) {
                msg='source:'
                 if (node.failed) {
                  mgroup='failed_sources'
                } else {
                  mgroup='good_sources'
                }
              } else {
                msg=''
                 if (node.failed) {
                  mgroup='failed_nodes'
                } else {
                  mgroup='good_nodes'
                }
              }

              // find participant
              participant_id=node.participant_id
              participant={}
               if (participant_id==null) {
                participant_id=0;
                if (!node.failed) {
                  participant.clr='blue'
                }
              } else {
                participant=list_of_participants[participant_id];
                }
               if (node.failed) {
                clr='red';
              } else {
                clr=participant.clr
              }


             // actually push the node to node list
              nodes.push({
                id: list_of_node_indx[node.id],
                label: msg+String(node.id), color:clr,
                title: ('<pre><code><font size="-2">'+ JSON.stringify(node, null, 2) + '</font></code></pre>'),
                group: mgroup,
                font: {align: 'inside'}
              });
            }

            // create edges for vectors
            for (var i = 0; i< ndata.net_structure.vectors.length; i++) {
              vector=ndata.net_structure.vectors[i]
              var from = vector.origin_id;
              var to = vector.destination_id;
              if (vector.failed) {
                mclr='red'
              } else {
              mclr='blue'
              }
              edges.push({
                from: list_of_node_indx[from],
                to: list_of_node_indx[to],
                arrows:'to',
                title: ('<pre><code><font size="-2">'+ JSON.stringify(vector, null, 2) + '</font></code></pre>'),
                color: mclr
              });
            }

            // now pushes infos
            for (var i = 0; i< ndata.net_structure.infos.length; i++) {
              info=ndata.net_structure.infos[i];
              count_nodes++;
              my_node_id=count_nodes;
              to=my_node_id;
              from=info.origin_id;
              participant_id=list_of_nodes[from].participant_id
              participant={}
              if (participant_id==null) {
                participant_id=0;
                participant.clr='black';
                participant='<empty>';
              } else {
                participant=list_of_participants[participant_id];
                }
               if (info.failed) {
                mgroup='failed_infos'
              } else {
                mgroup='good_infos'
              }
              nodes.push({
                id: my_node_id,
                label: "info:"+ String(info.id), dashes:true,
                title: ('<pre><code><font size="-2">'+ JSON.stringify(info, null, 2) + '</font></code></pre>'),
                group: mgroup,
                font: {align: 'inside'}

              });
              if (participant_id>0) {
                edges.push({
                from: list_of_node_indx[from],
                to: to,
                dashes:true,
                label: "participant: "+ String(participant_id), font: {size:15, color:participant.clr, strokeWidth:0, strokeColor:'yellow',align: 'top'},
                //arrows:'to', dashes:true,
                title: ('<pre><code><font size="-2">'+ JSON.stringify(participant, null, 2) + '</font></code></pre>'),
              });
              } else {
              edges.push({
                from: list_of_node_indx[from],
                to: to,
                dashes:true,
                //label: participant_id,      font: {align: 'top'},
                //arrows:'to', dashes:true,
                //title: ('<pre><code><font size="-2">'+ JSON.stringify(participant, null, 2) + '</font></code></pre>'),
              });
              }
            }

          group_fathres=[];
          for (var j=0;j<roles.length;j++) {
             //group fathers of all practice networks
             count_nodes++;
            my_node_id=count_nodes;
            clr=roles_colors[j]
            gtitle=roles[j] + ' networks'

            nodes.push({
                    id: my_node_id,
                    label: gtitle,
                    title: gtitle,
                    group: 'group_father',
                    font: {align: 'inside'},
                    icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0c2',
                                        size: 120,
                                        color: clr
                                    }
                  });
                  group_fathres[j]=my_node_id;
          }
           

          //connect network to correct source
          for (var i = 0; i< ndata.net_structure.networks.length; i++) {
                net=ndata.net_structure.networks[i];
                count_nodes++;
                my_node_id=count_nodes;
                from=my_node_id;
                is_found=false;
                
                min_id=99999999
                // find the node with minimal id that belong to this network
                for (var j = 0; j< ndata.net_structure.nodes.length; j++) {
                  node=ndata.net_structure.nodes[j];
                    if ((node.id<=min_id) && (node.network_id==net.id))  {
                      min_id=node.id
                      to_min=list_of_node_indx[node.id]
                      
                    }
                }


                // find the source that belong to this network
                for (var j = 0; j< ndata.net_structure.nodes.length; j++) {
                  node=ndata.net_structure.nodes[j];
                    if ((node.type.toLowerCase().search('source')>0) && (node.network_id==net.id))  {
                      is_found=true
                      to=list_of_node_indx[node.id]
                      break
                    }
                }
                
                if (!is_found) {
                  to=to_min // use a default strategy that the source is the minimal id
                    //to=my_node_id
                }

                
                  if (net.property1=='True') {
                      mgroup='group_networks_open';
                    } else {
                      mgroup='group_networks_close';
                    }
                    
                    father=group_fathres[networks_roles[net.id]]; // find father network
                    clr=roles_colors[networks_roles[net.id]];
                nodes.push({
                  id: my_node_id,
                  label: "network:"+ String(net.id),
                  title: ('<pre><code><font size="-2">'+ JSON.stringify(net, null, 2) + '</font></code></pre>'),
                  group: mgroup,
                  font: {align: 'inside'},
                  icon: {
                                        face: 'FontAwesome',
                                        code: '\uf0c2',
                                        color: clr
                                    }

                });
                 edges.push({
                  from: from,
                  to: to,
                  //arrows:'to', dashes:true,
                  //title: ('<pre><code><font size="-2">'+ JSON.stringify(info, null, 2) + '</font></code></pre>),
                  color: 'black'
                });
                 //connect network to father
                edges.push({
                  from: father,
                  to: from,
                  //arrows:'to', dashes:true,
                  //title: ('<pre><code><font size="-2">'+ JSON.stringify(info, null, 2) + '</font></code></pre>),
                  color: 'white',
                  font: {align: 'inside'}
                });

         

            }

          return {nodes:nodes, edges:edges};
        }

        function get_network_data() {
            //document.getElementById('debug').innerHTML=ndata;
            draw();
            // reqwest ({
            //     url: "/network_monitor_data/" ,
            //     method: 'get',
            //     type: 'json',
            //     success: function (resp) {
            //         console.log("got data sucess!")
            //         ndata=resp;
            //         console.log(ndata)
            //         draw();

            //    },
            //    error: function (err) {
            //      console.log("got data failure...")
            //     console.log(err);
            //     }
            // });
        }
        function destroy() {
            if (network !== null) {
                network.destroy();
                network = null;
            }
        }

        function draw() {

            destroy();
            // randomly create some nodes and edges

            var data = getnNetwork()

            // create a network
            var container = document.getElementById('mynetwork');

            var options=getOptions();
            network = new vis.Network(container, data, options);

            // add event listeners
            network.on('select', function (params) {
                document.getElementById('selection').innerHTML = 'Selection: ' + params.nodes;
            });
        }

    </script>

</head>

<body onload="get_network_data();">


<h2><i class="fa fa-cloud"></i> Network Monitor</h2>
<div id="stats">
{{ my_msg |safe }}
</div>
Zoom in to see details:

    <!--
        <p>

              <input type="button" id="mrefresh" value="refresh">
        </p>
    -->

<!--
<script language="javascript">
    var mrefresh = document.getElementById("mrefresh")
    mrefresh.onclick = function () {
        get_network_data();
    };
</script>
-->
<br>

<div id="mynetwork"></div>

<div id="debug"></div>
</body>
</html>
